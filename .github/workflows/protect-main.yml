name: Protect Main

on:
  workflow_dispatch:

jobs:
  protect:
    runs-on: ubuntu-latest
    steps:
      - name: Enforce branch protection on main
        env:
          REPO: ${{ github.repository }}
          TOKEN: ${{ secrets.REPO_ADMIN_TOKEN }}
        run: |
          curl -s -X PUT \
            -H "Authorization: token ${TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${REPO}/branches/main/protection \
            -d '{"required_status_checks":{"strict":true,"contexts":["CI"]},"enforce_admins":true,"required_pull_request_reviews":{"required_approving_review_count":1},"restrictions":null,"allow_force_pushes":false,"allow_deletions":false}'
